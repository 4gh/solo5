#!/bin/bash

if [ "$#" -lt 1 ]; then
    echo "Usage: ukvm-configure UKVM_SRC [MODULES]"
    echo "    UKVM_SRC is /path/to/ukvm"
    echo "    MODULES can be any combination of: net blk gdb"
    exit
fi

UKVM_SRC=`readlink -e $1`
shift
UKVM_MODULES=$@

(
echo "# Generated by ukvm-configure $@"
echo    
echo "UKVM_MODULE_OBJS= \\"
for m in $UKVM_MODULES; do
    echo "_build-ukvm/ukvm-$m.o \\"
done
echo 
echo "UKVM_MODULE_FLAGS= \\"
for m in $UKVM_MODULES; do
    echo "-DUKVM_MODULE_${m^^} \\"
done
echo 
cat <<EOF
UKVM_CC?=cc
UKVM_FLAGS=-D__UKVM_HOST__ \$(UKVM_MODULE_FLAGS)
UKVM_CFLAGS=-Wall -Werror -std=c99 -O2 -g \$(UKVM_FLAGS)
UKVM_OBJS=_build-ukvm/ukvm-core.o \$(UKVM_MODULE_OBJS)
UKVM_HEADERS= \\
$UKVM_SRC/ukvm.h \\
$UKVM_SRC/misc.h \\
$UKVM_SRC/processor-flags.h

_build-ukvm:
	mkdir -p _build-ukvm

_build-ukvm/ukvm-%.o: $UKVM_SRC/ukvm-%.c _build-ukvm 
	\$(UKVM_CC) \$(UKVM_CFLAGS) -c \$< -o \$@

ukvm-bin: \$(UKVM_OBJS) \$(UKVM_HEADERS)
	\$(UKVM_CC) -o \$@ \$(UKVM_CFLAGS) \$(UKVM_OBJS) -lpthread -lrt

.PHONY: ukvm-clean
ukvm-clean:
	\$(RM) -r _build-ukvm
	\$(RM) ukvm-bin 

EOF
) > Makefile.ukvm
